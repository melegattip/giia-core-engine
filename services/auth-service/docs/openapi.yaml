openapi: 3.0.3
info:
  title: GIIA Auth Service API
  description: |
    Authentication, authorization, and multi-tenancy management for the GIIA platform.
    
    ## Features
    - JWT-based authentication (access + refresh tokens)
    - Multi-tenant organization isolation
    - Role-Based Access Control (RBAC)
    - User registration with email verification
    - Password reset functionality
    - Rate limiting for security endpoints
    
    ## Authentication
    Most endpoints require a JWT Bearer token. Obtain one via `/auth/login`.
  version: 1.0.0
  contact:
    name: GIIA Team
    email: support@giia.io
  license:
    name: Proprietary
    url: https://giia.io/license

servers:
  - url: http://localhost:8081
    description: Local development server
  - url: https://api.giia.io
    description: Production server

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Users
    description: User management operations
  - name: Roles
    description: Role management operations
  - name: Permissions
    description: Permission management operations
  - name: Health
    description: Service health checks

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from /auth/login

  parameters:
    OrganizationHeader:
      name: X-Organization-ID
      in: header
      required: false
      schema:
        type: string
        format: uuid
      description: Organization context for multi-tenancy

  schemas:
    Error:
      type: object
      properties:
        error_code:
          type: string
          example: "BAD_REQUEST"
        message:
          type: string
          example: "Invalid request parameters"
      required:
        - error_code
        - message

    RegisterRequest:
      type: object
      required:
        - email
        - password
        - first_name
        - last_name
        - organization_id
      properties:
        email:
          type: string
          format: email
          example: "user@example.com"
        password:
          type: string
          format: password
          minLength: 8
          example: "SecurePassword123!"
          description: "Min 8 chars with uppercase, lowercase, digit, and special char"
        first_name:
          type: string
          maxLength: 100
          example: "John"
        last_name:
          type: string
          maxLength: 100
          example: "Doe"
        phone:
          type: string
          example: "+1234567890"
          description: "E.164 format"
        organization_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: "user@example.com"
        password:
          type: string
          format: password
          example: "SecurePassword123!"

    LoginResponse:
      type: object
      properties:
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIs..."
        expires_in:
          type: integer
          example: 900
          description: "Token expiry in seconds"
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        email:
          type: string
          format: email
          example: "user@example.com"
        first_name:
          type: string
          example: "John"
        last_name:
          type: string
          example: "Doe"
        phone:
          type: string
          example: "+1234567890"
        organization_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        status:
          type: string
          enum: [pending, active, suspended, deleted]
          example: "active"
        roles:
          type: array
          items:
            type: string
          example: ["user", "analyst"]
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    TokenRefreshResponse:
      type: object
      properties:
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIs..."
        expires_in:
          type: integer
          example: 900

    ActivateRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          example: "activation-token-from-email"

    ForgotPasswordRequest:
      type: object
      required:
        - email
        - organization_id
      properties:
        email:
          type: string
          format: email
          example: "user@example.com"
        organization_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"

    ResetPasswordRequest:
      type: object
      required:
        - token
        - password
      properties:
        token:
          type: string
          example: "reset-token-from-email"
        password:
          type: string
          format: password
          minLength: 8
          example: "NewSecurePassword123!"

    UpdateUserRequest:
      type: object
      properties:
        first_name:
          type: string
          maxLength: 100
          example: "John"
        last_name:
          type: string
          maxLength: 100
          example: "Smith"
        phone:
          type: string
          example: "+1987654321"

    Role:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "analyst"
        description:
          type: string
          example: "Can view analytics and reports"
        permissions:
          type: array
          items:
            type: string
          example: ["analytics:read", "reports:read"]
        created_at:
          type: string
          format: date-time

    Permission:
      type: object
      properties:
        id:
          type: string
          format: uuid
        resource:
          type: string
          example: "products"
        action:
          type: string
          enum: [create, read, update, delete]
          example: "read"
        description:
          type: string
          example: "Read access to products"

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          example: "healthy"
        database:
          type: string
          example: "connected"
        redis:
          type: string
          example: "connected"
        version:
          type: string
          example: "1.0.0"

    MessageResponse:
      type: object
      properties:
        message:
          type: string
          example: "Operation completed successfully"

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns service health status
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/v1/auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: |
        Create a new user account. Email verification is required.
        
        **Rate Limit:** 3 requests / 60 minutes / IP
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "User registered successfully. Please check your email for activation instructions."
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: |
        Authenticate user and receive JWT tokens.
        
        **Note:** Refresh token is returned as HTTP-only cookie with 7-day expiry.
        
        **Rate Limit:** 5 requests / 15 minutes / IP
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              schema:
                type: string
              description: HTTP-only cookie containing refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Account not activated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Obtain new access token using refresh token from HTTP-only cookie
      operationId: refreshToken
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenRefreshResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: Invalidate current session and refresh token
      operationId: logoutUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Logged out successfully"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/activate:
    post:
      tags:
        - Authentication
      summary: Activate account
      description: Activate user account using email token
      operationId: activateAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivateRequest'
      responses:
        '200':
          description: Account activated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Account activated successfully. You can now log in."
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/forgot-password:
    post:
      tags:
        - Authentication
      summary: Request password reset
      description: |
        Request password reset email.
        
        **Note:** Always returns success to prevent user enumeration.
        
        **Rate Limit:** 3 requests / 60 minutes / IP
      operationId: forgotPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: Password reset email sent (if account exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "If an account exists, a password reset email has been sent."
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/reset-password:
    post:
      tags:
        - Authentication
      summary: Reset password
      description: Reset password using token from email
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Password reset successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Password reset successfully. You can now log in."
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/me:
    get:
      tags:
        - Users
      summary: Get current user
      description: Get current authenticated user's profile
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Users
      summary: Update current user
      description: Update current user's profile
      operationId: updateCurrentUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User profile updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users:
    get:
      tags:
        - Users
      summary: List users
      description: List all users in the organization (admin only)
      operationId: listUsers
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, active, suspended, deleted]
        - name: role
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Users retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  total:
                    type: integer
                  page:
                    type: integer
                  page_size:
                    type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires admin role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/roles:
    get:
      tags:
        - Roles
      summary: List roles
      description: List all roles in the organization
      operationId: listRoles
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Roles retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags:
        - Roles
      summary: Create role
      description: Create a new role (admin only)
      operationId: createRole
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  example: "analyst"
                description:
                  type: string
                  example: "Can view analytics and reports"
                permissions:
                  type: array
                  items:
                    type: string
                  example: ["analytics:read", "reports:read"]
      responses:
        '201':
          description: Role created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires admin role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/permissions:
    get:
      tags:
        - Permissions
      summary: List permissions
      description: List all available permissions
      operationId: listPermissions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Permissions retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
