name: Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: "1.23"

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.64.8
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run golangci-lint on workspace modules
        run: |
          # Lint each service
          for service in services/*/; do
            if [ -f "${service}go.mod" ]; then
              echo "Linting ${service}"
              cd "${service}"
              golangci-lint run --timeout=5m ./... || exit 1
              cd - > /dev/null
            fi
          done

          # Lint shared packages
          for pkg in pkg/*/; do
            if [ -f "${pkg}go.mod" ]; then
              echo "Linting ${pkg}"
              cd "${pkg}"
              golangci-lint run --timeout=5m ./... || exit 1
              cd - > /dev/null
            fi
          done

  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: giia
          POSTGRES_PASSWORD: giia_test_password
          POSTGRES_DB: giia_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      nats:
        image: nats:2-alpine
        ports:
          - 4222:4222
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8222/healthz || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests for workspace modules
        run: |
          # Initialize combined coverage
          echo "mode: atomic" > coverage.out

          # Test each service
          for service in services/*/; do
            if [ -f "${service}go.mod" ]; then
              echo "Testing ${service}"
              cd "${service}"
              go mod download
              if go test -v -race -coverprofile=coverage.tmp -covermode=atomic ./... 2>&1 | tee test.log; then
                if [ -f coverage.tmp ]; then
                  tail -n +2 coverage.tmp >> ../../coverage.out
                  rm coverage.tmp
                fi
              else
                echo "Tests failed for ${service}"
                cat test.log
                exit 1
              fi
              cd - > /dev/null
            fi
          done

          # Test shared packages
          for pkg in pkg/*/; do
            if [ -f "${pkg}go.mod" ]; then
              echo "Testing ${pkg}"
              cd "${pkg}"
              go mod download
              if go test -v -race -coverprofile=coverage.tmp -covermode=atomic ./... 2>&1 | tee test.log; then
                if [ -f coverage.tmp ]; then
                  tail -n +2 coverage.tmp >> ../../coverage.out
                  rm coverage.tmp
                fi
              else
                echo "Tests failed for ${pkg}"
                cat test.log
                exit 1
              fi
              cd - > /dev/null
            fi
          done

      - name: Generate coverage report
        run: |
          if [ -f coverage.out ] && [ -s coverage.out ]; then
            go tool cover -func=coverage.out -o=coverage.txt
            echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat coverage.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No coverage data generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage to Codecov
        if: hashFiles('coverage.out') != ''
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: giia-core-engine
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: [lint, test]

    strategy:
      matrix:
        service:
          - auth-service
          - catalog-service
          - ddmrp-engine-service
          - execution-service
          - analytics-service
          - ai-agent-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build ${{ matrix.service }}
        run: |
          cd services/${{ matrix.service }}
          go build -v -o ../../bin/${{ matrix.service }} ./cmd/...

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}
          path: bin/${{ matrix.service }}
          retention-days: 7

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint, test, security, build]
    steps:
      - name: Quality gate passed
        run: echo "âœ… All quality checks passed!"
