name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: "1.23"

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

      - name: Check for breaking changes
        id: breaking
        run: |
          if git log --format=%B origin/${{ github.base_ref }}..${{ github.sha }} | grep -qi "BREAKING CHANGE"; then
            echo "breaking=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ This PR contains breaking changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "breaking=false" >> $GITHUB_OUTPUT
          fi

      - name: Label breaking changes
        if: steps.breaking.outputs.breaking == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['breaking-change']
            })

  changed-files:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      shared: ${{ steps.changes.outputs.shared }}
      workflows: ${{ steps.changes.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            services:
              - 'services/**'
            shared:
              - 'pkg/**'
            workflows:
              - '.github/workflows/**'

  lint-changed:
    name: Lint Changed Code
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.services == 'true' || needs.changed-files.outputs.shared == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --new-from-rev=origin/${{ github.base_ref }}

  test-changed:
    name: Test Changed Code
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.services == 'true' || needs.changed-files.outputs.shared == 'true'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: giia
          POSTGRES_PASSWORD: giia_test_password
          POSTGRES_DB: giia_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

      nats:
        image: nats:2-alpine
        ports:
          - 4222:4222

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get changed packages
        id: changed-packages
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep '\.go$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            PACKAGES=$(echo "$CHANGED_FILES" | xargs -I {} dirname {} | sort -u | xargs -I {} echo "./{}/...")
            echo "packages<<EOF" >> $GITHUB_OUTPUT
            echo "$PACKAGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run tests for changed packages
        if: steps.changed-packages.outputs.packages != ''
        run: |
          go test -v -race -coverprofile=coverage.out ${{ steps.changed-packages.outputs.packages }}

      - name: Comment PR with coverage
        if: steps.changed-packages.outputs.packages != ''
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('coverage.out')) {
              const { execSync } = require('child_process');
              const coverage = execSync('go tool cover -func=coverage.out').toString();
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ“Š Test Coverage for Changed Files\n\`\`\`\n${coverage}\n\`\`\``
              });
            }

  size-label:
    name: Label PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Calculate PR size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          fail_if_xl: false

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [pr-validation, lint-changed, test-changed]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## âœ… Pull Request Checks Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All automated checks have completed." >> $GITHUB_STEP_SUMMARY
          echo "Please wait for reviewer approval." >> $GITHUB_STEP_SUMMARY
